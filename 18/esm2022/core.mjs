import { Scope } from 'rete';
import { createCustomElement } from '@angular/elements';
function getRenderer() {
    const elements = new WeakMap();
    return {
        get(element) {
            return elements.get(element);
        },
        mount(element, key, component, injector, props) {
            // LIMITATION: If an element is remounted with the same identifier, the component cannot be replaced
            const exists = customElements.get(key);
            if (!exists) {
                customElements.define(key, createCustomElement(component, { injector }));
            }
            const ngElement = document.createElement(key);
            Object.keys(props).forEach(key => {
                ngElement[key] = props[key];
            });
            element.appendChild(ngElement);
            elements.set(element, { key, ngElement });
        },
        update({ ngElement }, props) {
            Object.keys(props).forEach(key => {
                ngElement.ngElementStrategy.setInputValue(key, props[key]);
            });
            ngElement.ngElementStrategy.setInputValue('seed', Math.random());
        },
        unmount(element) {
            const existing = elements.get(element);
            if (existing) {
                existing.ngElement.remove();
                elements.delete(element);
            }
        }
    };
}
/**
 * Angular plugin. Renders nodes, connections and other elements using React.
 * @priority 9
 * @emits connectionpath
 * @listens render
 * @listens unmount
 */
export class AngularPlugin extends Scope {
    params;
    presets = [];
    renderer;
    owners = new WeakMap();
    /**
     * @constructor
     * @param params Plugin properties
     * @param params.injector Angular's Injector instance
     */
    constructor(params) {
        super('angular-render');
        this.params = params;
        this.renderer = getRenderer();
        this.addPipe(context => {
            if (!context || typeof context !== 'object' || !('type' in context))
                return context;
            if (context.type === 'unmount') {
                this.unmount(context.data.element);
            }
            else if (context.type === 'render') {
                if ('filled' in context.data && context.data.filled) {
                    return context;
                }
                if (this.mount(context.data.element, context)) {
                    return {
                        ...context,
                        data: {
                            ...context.data,
                            filled: true
                        }
                    };
                }
            }
            return context;
        });
    }
    setParent(scope) {
        super.setParent(scope);
        this.presets.forEach(preset => {
            if (preset.attach)
                preset.attach(this);
        });
    }
    unmount(element) {
        this.owners.delete(element);
        this.renderer.unmount(element);
    }
    mount(element, context) {
        const existing = this.renderer.get(element);
        if (existing) {
            this.presets.forEach(preset => {
                if (this.owners.get(element) !== preset)
                    return;
                const result = preset.update(context, this);
                if (result) {
                    this.renderer.update(existing, result);
                }
            });
            return true;
        }
        for (const preset of this.presets) {
            const result = preset.mount(context, this);
            if (!result)
                continue;
            const { key, component, props } = result;
            this.renderer.mount(element, key, component, this.params.injector, props);
            this.owners.set(element, preset);
            return true;
        }
        return;
    }
    /**
     * Adds a preset to the plugin.
     * @param preset Preset that can render nodes, connections and other elements.
     */
    addPreset(preset) {
        const local = preset;
        if (local.attach)
            local.attach(this);
        this.presets.push(local);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL25nMTgvLnNyYy9jb3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBZ0MsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFBO0FBQzFELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBYXhELFNBQVMsV0FBVztJQUNsQixNQUFNLFFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBcUIsQ0FBQTtJQUVqRCxPQUFPO1FBQ0wsR0FBRyxDQUFDLE9BQU87WUFDVCxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDOUIsQ0FBQztRQUNELEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsS0FBSztZQUM1QyxvR0FBb0c7WUFDcEcsTUFBTSxNQUFNLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUV0QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQ1osY0FBYyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsbUJBQW1CLENBQUMsU0FBUyxFQUFFLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFBO1lBQzFFLENBQUM7WUFFRCxNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBeUMsQ0FBQTtZQUVyRixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDL0IsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUM3QixDQUFDLENBQUMsQ0FBQTtZQUVGLE9BQU8sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUE7WUFDOUIsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFF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UUFDYixDQUFDO1FBQ0QsT0FBTTtJQUNSLENBQUM7SUFFRDs7O09BR0c7SUFDSSxTQUFTLENBQUksTUFBa0k7UUFDcEosTUFBTSxLQUFLLEdBQUcsTUFBNkMsQ0FBQTtRQUUzRCxJQUFJLEtBQUssQ0FBQyxNQUFNO1lBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNwQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTtJQUMxQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCYXNlU2NoZW1lcywgQ2FuQXNzaWduU2lnbmFsLCBTY29wZSB9IGZyb20gJ3JldGUnXHJcbmltcG9ydCB7IGNyZWF0ZUN1c3RvbUVsZW1lbnQgfSBmcm9tICdAYW5ndWxhci9lbGVtZW50cyc7XHJcblxyXG5pbXBvcnQgeyBOZ0VsZW1lbnQsIE5vZGVQcm9wcywgUG9zaXRpb24sIFJlbmRlclNpZ25hbCB9IGZyb20gJy4vdHlwZXMnXHJcbmltcG9ydCB7IFJlbmRlclByZXNldCB9IGZyb20gJy4vcHJlc2V0cy90eXBlcyc7XHJcblxyXG50eXBlIEl0ZW0gPSB7IGtleTogc3RyaW5nLCBuZ0VsZW1lbnQ6IE5nRWxlbWVudCB9XHJcblxyXG50eXBlIFJlbmRlcmVyID0ge1xyXG4gIGdldChlbGVtZW50OiBIVE1MRWxlbWVudCk6IEl0ZW0gfCB1bmRlZmluZWRcclxuICBtb3VudChlbGVtZW50OiBIVE1MRWxlbWVudCwga2V5OiBzdHJpbmcsIGNvbXBvbmVudDogYW55LCBpbmplY3RvcjogSW5qZWN0b3IsIHByb3BzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPik6IHZvaWRcclxuICB1cGRhdGUoaXRlbTogSXRlbSwgcHJvcHM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+KTogdm9pZFxyXG4gIHVubW91bnQoZWxlbWVudDogSFRNTEVsZW1lbnQpOiB2b2lkXHJcbn1cclxuZnVuY3Rpb24gZ2V0UmVuZGVyZXIoKTogUmVuZGVyZXIge1xyXG4gIGNvbnN0IGVsZW1lbnRzID0gbmV3IFdlYWtNYXA8SFRNTEVsZW1lbnQsIEl0ZW0+KClcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIGdldChlbGVtZW50KSB7XHJcbiAgICAgIHJldHVybiBlbGVtZW50cy5nZXQoZWxlbWVudClcclxuICAgIH0sXHJcbiAgICBtb3VudChlbGVtZW50LCBrZXksIGNvbXBvbmVudCwgaW5qZWN0b3IsIHByb3BzKSB7XHJcbiAgICAgIC8vIExJTUlUQVRJT046IElmIGFuIGVsZW1lbnQgaXMgcmVtb3VudGVkIHdpdGggdGhlIHNhbWUgaWRlbnRpZmllciwgdGhlIGNvbXBvbmVudCBjYW5ub3QgYmUgcmVwbGFjZWRcclxuICAgICAgY29uc3QgZXhpc3RzID0gY3VzdG9tRWxlbWVudHMuZ2V0KGtleSlcclxuXHJcbiAgICAgIGlmICghZXhpc3RzKSB7XHJcbiAgICAgICAgY3VzdG9tRWxlbWVudHMuZGVmaW5lKGtleSwgY3JlYXRlQ3VzdG9tRWxlbWVudChjb21wb25lbnQsIHsgaW5qZWN0b3IgfSkpXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IG5nRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoa2V5KSBhcyBOb2RlUHJvcHMgJiBOZ0VsZW1lbnQgJiB0eXBlb2YgcHJvcHNcclxuXHJcbiAgICAgIE9iamVjdC5rZXlzKHByb3BzKS5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgICAgbmdFbGVtZW50W2tleV0gPSBwcm9wc1trZXldXHJcbiAgICAgIH0pXHJcblxyXG4gICAgICBlbGVtZW50LmFwcGVuZENoaWxkKG5nRWxlbWVudClcclxuICAgICAgZWxlbWVudHMuc2V0KGVsZW1lbnQsIHsga2V5LCBuZ0VsZW1lbnQgfSlcclxuICAgIH0sXHJcbiAgICB1cGRhdGUoeyBuZ0VsZW1lbnQgfSwgcHJvcHMpIHtcclxuICAgICAgT2JqZWN0LmtleXMocHJvcHMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgICBuZ0VsZW1lbnQubmdFbGVtZW50U3RyYXRlZ3kuc2V0SW5wdXRWYWx1ZShrZXksIHByb3BzW2tleV0pXHJcbiAgICAgIH0pXHJcbiAgICAgIG5nRWxlbWVudC5uZ0VsZW1lbnRTdHJhdGVneS5zZXRJbnB1dFZhbHVlKCdzZWVkJywgTWF0aC5yYW5kb20oKSlcclxuICAgIH0sXHJcbiAgICB1bm1vdW50KGVsZW1lbnQpIHtcclxuICAgICAgY29uc3QgZXhpc3RpbmcgPSBlbGVtZW50cy5nZXQoZWxlbWVudClcclxuXHJcbiAgICAgIGlmIChleGlzdGluZykge1xyXG4gICAgICAgIGV4aXN0aW5nLm5nRWxlbWVudC5yZW1vdmUoKVxyXG4gICAgICAgIGVsZW1lbnRzLmRlbGV0ZShlbGVtZW50KVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogU2lnbmFscyB0aGF0IGNhbiBiZSBlbWl0dGVkIGJ5IHRoZSBwbHVnaW5cclxuICogQHByaW9yaXR5IDEwXHJcbiAqL1xyXG5leHBvcnQgdHlwZSBQcm9kdWNlczxTY2hlbWVzIGV4dGVuZHMgQmFzZVNjaGVtZXM+ID1cclxuICB8IHsgdHlwZTogJ2Nvbm5lY3Rpb25wYXRoJywgZGF0YTogeyBwYXlsb2FkOiBTY2hlbWVzWydDb25uZWN0aW9uJ10sIHBhdGg/OiBzdHJpbmcsIHBvaW50czogUG9zaXRpb25bXSB9IH1cclxuXHJcbnR5cGUgUmVxdWlyZXM8U2NoZW1lcyBleHRlbmRzIEJhc2VTY2hlbWVzPiA9XHJcbiAgfCBSZW5kZXJTaWduYWw8J25vZGUnLCB7IHBheWxvYWQ6IFNjaGVtZXNbJ05vZGUnXSB9PlxyXG4gIHwgUmVuZGVyU2lnbmFsPCdjb25uZWN0aW9uJywgeyBwYXlsb2FkOiBTY2hlbWVzWydDb25uZWN0aW9uJ10sIHN0YXJ0PzogUG9zaXRpb24sIGVuZD86IFBvc2l0aW9uIH0+XHJcbiAgfCB7IHR5cGU6ICd1bm1vdW50JywgZGF0YTogeyBlbGVtZW50OiBIVE1MRWxlbWVudCB9IH1cclxuXHJcbi8qKlxyXG4gKiBBbmd1bGFyIHBsdWdpbi4gUmVuZGVycyBub2RlcywgY29ubmVjdGlvbnMgYW5kIG90aGVyIGVsZW1lbnRzIHVzaW5nIFJlYWN0LlxyXG4gKiBAcHJpb3JpdHkgOVxyXG4gKiBAZW1pdHMgY29ubmVjdGlvbnBhdGhcclxuICogQGxpc3RlbnMgcmVuZGVyXHJcbiAqIEBsaXN0ZW5zIHVubW91bnRcclxuICovXHJcbmV4cG9ydCBjbGFzcyBBbmd1bGFyUGx1Z2luPFNjaGVtZXMgZXh0ZW5kcyBCYXNlU2NoZW1lcywgVCA9IFJlcXVpcmVzPFNjaGVtZXM+PiBleHRlbmRzIFNjb3BlPFByb2R1Y2VzPFNjaGVtZXM+LCBbUmVxdWlyZXM8U2NoZW1lcz4gfCBUXT4ge1xyXG4gIHByZXNldHM6IFJlbmRlclByZXNldDxTY2hlbWVzLCBUPltdID0gW11cclxuICByZW5kZXJlcjogUmVuZGVyZXJcclxuICBvd25lcnMgPSBuZXcgV2Vha01hcDxIVE1MRWxlbWVudCwgUmVuZGVyUHJlc2V0PFNjaGVtZXMsIFQ+PigpXHJcblxyXG4gIC8qKlxyXG4gICAqIEBjb25zdHJ1Y3RvclxyXG4gICAqIEBwYXJhbSBwYXJhbXMgUGx1Z2luIHByb3BlcnRpZXNcclxuICAgKiBAcGFyYW0gcGFyYW1zLmluamVjdG9yIEFuZ3VsYXIncyBJbmplY3RvciBpbnN0YW5jZVxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcGFyYW1zOiB7IGluamVjdG9yOiBJbmplY3RvciB9KSB7XHJcbiAgICBzdXBlcignYW5ndWxhci1yZW5kZXInKVxyXG4gICAgdGhpcy5yZW5kZXJlciA9IGdldFJlbmRlcmVyKClcclxuXHJcbiAgICB0aGlzLmFkZFBpcGUoY29udGV4dCA9PiB7XHJcbiAgICAgIGlmICghY29udGV4dCB8fCB0eXBlb2YgY29udGV4dCAhPT0gJ29iamVjdCcgfHwgISgndHlwZScgaW4gY29udGV4dCkpIHJldHVybiBjb250ZXh0XHJcbiAgICAgIGlmIChjb250ZXh0LnR5cGUgPT09ICd1bm1vdW50Jykge1xyXG4gICAgICAgIHRoaXMudW5tb3VudChjb250ZXh0LmRhdGEuZWxlbWVudClcclxuICAgICAgfSBlbHNlIGlmIChjb250ZXh0LnR5cGUgPT09ICdyZW5kZXInKSB7XHJcbiAgICAgICAgaWYgKCdmaWxsZWQnIGluIGNvbnRleHQuZGF0YSAmJiBjb250ZXh0LmRhdGEuZmlsbGVkKSB7XHJcbiAgICAgICAgICByZXR1cm4gY29udGV4dFxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5tb3VudChjb250ZXh0LmRhdGEuZWxlbWVudCwgY29udGV4dCkpIHtcclxuICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIC4uLmNvbnRleHQsXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAuLi5jb250ZXh0LmRhdGEsXHJcbiAgICAgICAgICAgICAgZmlsbGVkOiB0cnVlXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gYXMgdHlwZW9mIGNvbnRleHRcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGNvbnRleHRcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBzZXRQYXJlbnQoc2NvcGU6IFNjb3BlPFJlcXVpcmVzPFNjaGVtZXM+IHwgVD4pOiB2b2lkIHtcclxuICAgIHN1cGVyLnNldFBhcmVudChzY29wZSlcclxuXHJcbiAgICB0aGlzLnByZXNldHMuZm9yRWFjaChwcmVzZXQgPT4ge1xyXG4gICAgICBpZiAocHJlc2V0LmF0dGFjaCkgcHJlc2V0LmF0dGFjaCh0aGlzKVxyXG4gICAgfSlcclxuICB9XHJcblxyXG5cclxuICBwcml2YXRlIHVubW91bnQoZWxlbWVudDogSFRNTEVsZW1lbnQpIHtcclxuICAgIHRoaXMub3duZXJzLmRlbGV0ZShlbGVtZW50KVxyXG4gICAgdGhpcy5yZW5kZXJlci51bm1vdW50KGVsZW1lbnQpXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG1vdW50KGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBjb250ZXh0OiBSZXF1aXJlczxTY2hlbWVzPikge1xyXG4gICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLnJlbmRlcmVyLmdldChlbGVtZW50KVxyXG5cclxuICAgIGlmIChleGlzdGluZykge1xyXG4gICAgICB0aGlzLnByZXNldHMuZm9yRWFjaChwcmVzZXQgPT4ge1xyXG4gICAgICAgIGlmICh0aGlzLm93bmVycy5nZXQoZWxlbWVudCkgIT09IHByZXNldCkgcmV0dXJuXHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcHJlc2V0LnVwZGF0ZShjb250ZXh0IGFzIHVua25vd24gYXMgRXh0cmFjdDxULCB7IHR5cGU6ICdyZW5kZXInIH0+LCB0aGlzKVxyXG5cclxuICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICB0aGlzLnJlbmRlcmVyLnVwZGF0ZShleGlzdGluZywgcmVzdWx0KVxyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICAgcmV0dXJuIHRydWVcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IHByZXNldCBvZiB0aGlzLnByZXNldHMpIHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gcHJlc2V0Lm1vdW50KGNvbnRleHQgYXMgdW5rbm93biBhcyBFeHRyYWN0PFQsIHsgdHlwZTogJ3JlbmRlcicgfT4sIHRoaXMpXHJcblxyXG4gICAgICBpZiAoIXJlc3VsdCkgY29udGludWVcclxuXHJcbiAgICAgIGNvbnN0IHsga2V5LCBjb21wb25lbnQsIHByb3BzIH0gPSByZXN1bHRcclxuXHJcbiAgICAgIHRoaXMucmVuZGVyZXIubW91bnQoZWxlbWVudCwga2V5LCBjb21wb25lbnQsIHRoaXMucGFyYW1zLmluamVjdG9yLCBwcm9wcylcclxuXHJcbiAgICAgIHRoaXMub3duZXJzLnNldChlbGVtZW50LCBwcmVzZXQpXHJcbiAgICAgIHJldHVybiB0cnVlXHJcbiAgICB9XHJcbiAgICByZXR1cm5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEFkZHMgYSBwcmVzZXQgdG8gdGhlIHBsdWdpbi5cclxuICAgKiBAcGFyYW0gcHJlc2V0IFByZXNldCB0aGF0IGNhbiByZW5kZXIgbm9kZXMsIGNvbm5lY3Rpb25zIGFuZCBvdGhlciBlbGVtZW50cy5cclxuICAgKi9cclxuICBwdWJsaWMgYWRkUHJlc2V0PEs+KHByZXNldDogUmVuZGVyUHJlc2V0PFNjaGVtZXMsIENhbkFzc2lnblNpZ25hbDxULCBLPiBleHRlbmRzIHRydWUgPyBLIDogJ0Nhbm5vdCBhcHBseSBwcmVzZXQuIFByb3ZpZGVkIHNpZ25hbHMgYXJlIG5vdCBjb21wYXRpYmxlJz4pIHtcclxuICAgIGNvbnN0IGxvY2FsID0gcHJlc2V0IGFzIHVua25vd24gYXMgUmVuZGVyUHJlc2V0PFNjaGVtZXMsIFQ+XHJcblxyXG4gICAgaWYgKGxvY2FsLmF0dGFjaCkgbG9jYWwuYXR0YWNoKHRoaXMpXHJcbiAgICB0aGlzLnByZXNldHMucHVzaChsb2NhbClcclxuICB9XHJcbn1cclxuIl19